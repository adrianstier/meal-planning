# Agent System -- Bug Bash Report

## Bugs Fixed

| # | File:Line | Severity | Description | Fix Applied |
|---|-----------|----------|-------------|-------------|
| 1 | `orchestrator.ts:404-417` | High | `handleGeneralQuestion` never receives the user's actual message. When the orchestrator classifies an intent as `general_question` or `unknown`, `aggregateResponses` calls `handleGeneralQuestion(intent, context)` which passes only extracted entity JSON or the generic string "Please help with this general question" to the AI -- the user's actual question is lost entirely. This means any general cooking question gets a meaningless AI response. | Changed `aggregateResponses` to accept and pass through the original `userMessage` string. Changed `handleGeneralQuestion` signature from `(intent: IntentClassification, context)` to `(userMessage: string, context)` so the user's actual question is sent to Claude. |
| 2 | `recipe-agent.ts:309-314` | High | `processImage` extracts base64 image data (line 298-299) but then calls `this.callAI()` with only a text prompt ("Please extract the recipe from this image"). The `callAI` method in `base-agent.ts` only constructs text-based messages -- the image data is never included in the API request. Claude Vision requires the image in a multipart content block to actually see it, so image-based recipe parsing always fails silently (Claude gets no image, just a text request). | Replaced the `callAI()` call with a direct `fetch()` to the Anthropic API that constructs a proper multipart message with an `image` content block containing the base64 data alongside the text prompt. Added proper error handling, timeout, and cost calculation. |
| 3 | `shopping-agent.ts:485-492` | Medium | `handleCostEstimate` calls `estimateCost` tool but does not check if the result was successful or if `data` is null before accessing `estimate.total.toFixed(2)`. If the AI fails to return valid JSON, `estimateCost` returns `{ success: false, error: ... }` and the code crashes with a TypeError trying to call `.toFixed()` on undefined. | Added a guard checking `!costResult.success || !costResult.data` before accessing the estimate properties, returning a user-friendly error message on failure. |
| 4 | `recipe-agent.ts:620` | Low | `estimateNutrition` returns `{ success: true, data: nutrition }` even when `parseJSON` returns `null`, yielding `{ success: true, data: null }`. While the caller does check `nutritionResult.data` before using it, returning `success: true` with null data is semantically incorrect and could mislead future callers. | Added a null check: if `nutrition` is null, now returns `{ success: false, error: 'Failed to parse nutrition estimate' }`. |

## Issues Noted (not fixed)

| # | File:Line | Severity | Description | Reason Not Fixed |
|---|-----------|----------|-------------|-----------------|
| 1 | `planning-agent.ts:484` | Low | `queryRecipes` passes user-influenced `cuisine` parameter directly into `.ilike('cuisine', '%${params.cuisine}%')` without escaping PostgREST wildcard characters (`%`, `_`). A crafted cuisine string could alter the query behavior. Risk is low because the parameter comes from AI tool calls (not direct user input), but prompt injection could potentially exploit this. | The parameter originates from AI intent classification, not direct user input. Fixing requires adding a PostgREST escaping utility, which is an enhancement beyond this scope. |
| 2 | `orchestrator.ts:15` | Low | `ExtractedEntity` is imported but never used in the file. | Pre-existing unused import; code style issue, not a bug. |
| 3 | `AgentChat.tsx:363-368` | Low | ThumbsUp and ThumbsDown feedback buttons have no `onClick` handlers -- they render but do nothing when clicked. The `useAgentFeedback` hook exists in `useAgent.ts` but is never wired up to these buttons. | Functional gap rather than a runtime bug. The buttons are non-functional but don't crash. Wiring them up would require design decisions about which message ID to associate with feedback. |
| 4 | `agent/index.ts` (endpoint) | Info | The endpoint (line 180-424) uses a standalone `callAI` function rather than the multi-agent orchestrator system. The entire `_shared/agents/` framework (orchestrator, specialized agents) is never invoked by the actual edge function. The endpoint simply calls Claude directly with a static system prompt. | This is an architectural observation. The multi-agent framework exists in code but the endpoint uses a simpler direct-call pattern. Not a bug per se -- both approaches work -- but it means the agent routing, tool execution, and multi-agent coordination code is effectively dead code in production. |
| 5 | `useAgent.ts:63` | Low | `callAgent` calls `supabase.auth.getSession()` instead of `supabase.auth.getUser()` to get the access token. The CLAUDE.md project conventions state "Always use `supabase.auth.getUser()` in server components, never `getSession()`". However, this is a client-side hook (not a server component), and `getSession()` is the standard way to access the token on the client without making a network call. The token is then verified server-side by the edge function via `getUser()`. | Convention mismatch only applies to server components per CLAUDE.md. The client-side usage is acceptable since the token is re-verified server-side at line 223 of the edge function. |

## Files Reviewed (clean)

- `/Users/adrianstier/meal-planning/supabase/functions/_shared/agents/types.ts` -- Well-defined type system, no issues.
- `/Users/adrianstier/meal-planning/supabase/functions/_shared/agents/base-agent.ts` -- Solid base class with proper timeout handling, JSON parsing, and error handling.
- `/Users/adrianstier/meal-planning/supabase/functions/_shared/agents/planning-agent.ts` -- Clean implementation aside from the noted PostgREST escaping concern.
- `/Users/adrianstier/meal-planning/supabase/functions/_shared/agents/nutrition-agent.ts` -- No bugs found. Proper error handling throughout.
- `/Users/adrianstier/meal-planning/supabase/functions/_shared/agents/index.ts` -- Simple re-export barrel file, no issues.
- `/Users/adrianstier/meal-planning/supabase/functions/agent/index.ts` -- Well-structured endpoint with proper CORS, CSRF, rate limiting, auth validation, input validation, and error handling.
- `/Users/adrianstier/meal-planning/client/src/hooks/useAgent.ts` -- Clean implementation with proper AbortController lifecycle, timeout handling, and optimistic UI updates.
- `/Users/adrianstier/meal-planning/client/src/components/features/agent/AgentChat.tsx` -- Clean UI component with proper markdown rendering via ReactMarkdown (XSS-safe), accessibility, and loading states.
- `/Users/adrianstier/meal-planning/client/src/components/features/agent/index.ts` -- Simple re-export file, no issues.
