# üí≥ Stripe Payment Integration - Complete Setup Guide

**This guide will help you add payments to your meal planning app in under 1 hour.**

---

## üéØ What You'll Accomplish

By following this guide, you'll have:

‚úÖ Stripe payment processing working
‚úÖ 3 pricing tiers (Free, Family $9.99, Premium $19.99)
‚úÖ 14-day free trials
‚úÖ Automatic subscription management
‚úÖ Feature access control (AI parsing, nutrition, etc.)
‚úÖ Customer billing portal
‚úÖ Webhook handling for payment events

---

## ‚ö° QUICK START (5 Minutes)

### Step 1: Create Stripe Account

1. Go to https://stripe.com
2. Click "Sign Up"
3. Complete registration
4. **Important**: Stay in TEST MODE (toggle in top-right)

### Step 2: Get Your API Keys

1. In Stripe Dashboard, go to **Developers ‚Üí API Keys**
2. Copy your **Secret key** (starts with `sk_test_`)
3. Add to your `.env` file:

```bash
# Add this to your .env file
STRIPE_SECRET_KEY=sk_test_your_key_here
STRIPE_WEBHOOK_SECRET=  # We'll fill this later
```

### Step 3: Run Database Migration

```bash
# This creates all the subscription tables
python database/migrations/add_subscriptions.py
```

You should see:
```
‚úÖ Subscriptions migration complete!
   - subscriptions table created
   - payment_history table created
   - plan_features table created with 4 tiers
```

### Step 4: Add Stripe Routes to Your App

Edit `app.py` and add these lines after the existing imports (around line 28):

```python
# Add this import
from stripe_routes import stripe_bp

# Add this after app initialization (around line 44)
app.register_blueprint(stripe_bp)
```

### Step 5: Test It Works

```bash
# Start your app
python app.py
```

Visit: http://localhost:5001/api/stripe/pricing

You should see pricing information for all plans!

---

## üìã COMPLETE INTEGRATION STEPS

### 1. Install Stripe Package

```bash
pip install stripe
```

Already done! ‚úÖ (added to requirements.txt)

### 2. Set Up Environment Variables

Edit your `.env` file:

```bash
# Stripe Configuration
STRIPE_SECRET_KEY=sk_test_YOUR_KEY_HERE  # Replace with your actual test key from Stripe Dashboard
STRIPE_WEBHOOK_SECRET=whsec_YOUR_WEBHOOK_SECRET  # We'll add this after webhook setup
```

**Where to find these:**
- Secret Key: Stripe Dashboard ‚Üí Developers ‚Üí API Keys
- Webhook Secret: We'll get this in Step 6

### 3. Database Migration (If Not Done)

```bash
python database/migrations/add_subscriptions.py
```

This creates 4 tables:
- `subscriptions` - User subscription data
- `payment_history` - Payment records
- `plan_features` - What each plan tier includes
- `feature_usage` - Usage tracking for rate limiting

### 4. Integrate Stripe Routes

**Edit `app.py`:**

```python
# Around line 17, add this import:
from stripe_routes import stripe_bp

# Around line 44 (after app initialization), add:
app.register_blueprint(stripe_bp)
```

That's it! All Stripe endpoints are now available:

- `POST /api/stripe/create-checkout-session` - Start payment
- `GET /api/stripe/subscription` - Get user's plan
- `POST /api/stripe/cancel` - Cancel subscription
- `POST /api/stripe/webhook` - Handle Stripe events
- `GET /api/stripe/pricing` - Get pricing info (public)

### 5. Protect Premium Endpoints

Now you can protect any endpoint with subscription checks.

**Example - Protect AI Recipe Parsing:**

Edit `app.py`, find the `/api/meals/parse` endpoint (around line 700), and modify it:

```python
@app.route('/api/meals/parse', methods=['POST'])
@login_required
def parse_recipe_with_ai():
    """AI recipe parsing - PREMIUM FEATURE"""

    # ADD THIS CODE at the start of the function:
    from subscription_manager import get_subscription_manager

    user_id = get_current_user_id()
    sub_manager = get_subscription_manager()

    # Check if user can use this feature
    can_access, reason = sub_manager.can_use_feature(user_id, 'ai_recipe_parsing')
    if not can_access:
        return jsonify({
            'success': False,
            'error': reason,
            'upgrade_required': True  # Frontend can show upgrade modal
        }), 403

    # EXISTING CODE CONTINUES HERE
    # ... rest of the function ...

    # AT THE END, track usage:
    sub_manager.track_feature_usage(user_id, 'ai_recipe_parsing')

    return jsonify({'success': True, 'meal': parsed_meal})
```

**Repeat for other premium endpoints:**
- Nutrition tracking
- Analytics dashboard
- Meal prep mode
- Budget tracking

### 6. Set Up Webhooks

Webhooks let Stripe notify your app about payment events.

**Local Testing (Development):**

1. Install Stripe CLI:
   ```bash
   brew install stripe/stripe-cli/stripe
   # OR download from https://stripe.com/docs/stripe-cli
   ```

2. Login to Stripe:
   ```bash
   stripe login
   ```

3. Forward webhooks to your local app:
   ```bash
   stripe listen --forward-to localhost:5001/api/stripe/webhook
   ```

4. Copy the webhook secret (starts with `whsec_`) and add to `.env`:
   ```bash
   STRIPE_WEBHOOK_SECRET=whsec_xxx
   ```

5. Keep this running while testing payments!

**Production Webhooks (Railway/Deployed):**

1. Go to Stripe Dashboard ‚Üí Developers ‚Üí Webhooks
2. Click "+ Add endpoint"
3. Enter your production URL: `https://your-app.railway.app/api/stripe/webhook`
4. Select events to listen for:
   - `checkout.session.completed`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
   - `invoice.payment_succeeded`
   - `invoice.payment_failed`
5. Click "Add endpoint"
6. Copy the webhook secret and add to Railway environment variables

### 7. Test the Payment Flow

**Method 1: Using Stripe Test Cards**

1. Start your app: `python app.py`
2. Make a request to create checkout:

```bash
curl -X POST http://localhost:5001/api/stripe/create-checkout-session \
  -H "Content-Type: application/json" \
  -d '{"plan_tier": "family"}' \
  -b cookies.txt
```

3. Open the returned `checkout_url` in your browser
4. Use Stripe test card: `4242 4242 4242 4242`
   - Any future expiry date
   - Any 3-digit CVC
   - Any ZIP code

5. Complete payment
6. Check your database:

```bash
sqlite3 meal_planner.db "SELECT plan_tier, status FROM subscriptions WHERE user_id=1;"
```

Should show: `family|active`

**Method 2: Frontend Integration (Next Step)**

---

## üé® Frontend Integration

### Add to Your React App

**1. Create Subscription Page (`client/src/pages/SubscriptionPage.tsx`):**

```typescript
import React, { useState } from 'react';
import { api } from '../lib/api';
import { Button } from '../components/ui/button';
import { Card } from '../components/ui/card';

export default function SubscriptionPage() {
  const [loading, setLoading] = useState(false);

  const handleSubscribe = async (planTier: string) => {
    setLoading(true);
    try {
      const response = await api.post('/api/stripe/create-checkout-session', {
        plan_tier: planTier
      });

      // Redirect to Stripe Checkout
      window.location.href = response.data.checkout_url;
    } catch (error) {
      console.error('Failed to create checkout session:', error);
      alert('Failed to start checkout. Please try again.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="container mx-auto px-4 py-8">
      <h1 className="text-3xl font-bold mb-8">Choose Your Plan</h1>

      <div className="grid md:grid-cols-3 gap-6">
        {/* Free Plan */}
        <Card className="p-6">
          <h2 className="text-2xl font-bold mb-4">Free</h2>
          <p className="text-4xl font-bold mb-4">$0<span className="text-lg">/month</span></p>
          <ul className="space-y-2 mb-6">
            <li>‚úì Up to 10 recipes</li>
            <li>‚úì Basic meal planning</li>
            <li>‚úì Shopping lists</li>
          </ul>
          <Button disabled className="w-full">Current Plan</Button>
        </Card>

        {/* Family Plan */}
        <Card className="p-6 border-2 border-blue-500 relative">
          <div className="absolute top-0 right-0 bg-blue-500 text-white px-3 py-1 text-sm">
            Most Popular
          </div>
          <h2 className="text-2xl font-bold mb-4">Family</h2>
          <p className="text-4xl font-bold mb-4">$9.99<span className="text-lg">/month</span></p>
          <ul className="space-y-2 mb-6">
            <li>‚úì Unlimited recipes</li>
            <li>‚úì 50 AI parses/month</li>
            <li>‚úì Nutrition tracking</li>
            <li>‚úì Analytics dashboard</li>
            <li>‚úì Meal prep mode</li>
          </ul>
          <Button
            onClick={() => handleSubscribe('family')}
            disabled={loading}
            className="w-full"
          >
            Start 14-Day Free Trial
          </Button>
        </Card>

        {/* Premium Plan */}
        <Card className="p-6">
          <h2 className="text-2xl font-bold mb-4">Premium</h2>
          <p className="text-4xl font-bold mb-4">$19.99<span className="text-lg">/month</span></p>
          <ul className="space-y-2 mb-6">
            <li>‚úì Everything in Family</li>
            <li>‚úì Unlimited AI features</li>
            <li>‚úì AI meal assistant</li>
            <li>‚úì Family sharing (5 members)</li>
            <li>‚úì Priority support</li>
          </ul>
          <Button
            onClick={() => handleSubscribe('premium')}
            disabled={loading}
            className="w-full"
          >
            Start 14-Day Free Trial
          </Button>
        </Card>
      </div>
    </div>
  );
}
```

**2. Add Success/Cancel Pages:**

```typescript
// client/src/pages/SubscriptionSuccessPage.tsx
export default function SubscriptionSuccess() {
  return (
    <div className="container mx-auto px-4 py-16 text-center">
      <h1 className="text-4xl font-bold text-green-600 mb-4">Welcome to Premium!</h1>
      <p className="text-xl mb-8">Your subscription is now active.</p>
      <a href="/recipes" className="text-blue-600 underline">
        Start using premium features ‚Üí
      </a>
    </div>
  );
}
```

**3. Show Upgrade Prompts:**

When user hits a premium feature:

```typescript
// In your recipe parsing component
const handleParseRecipe = async () => {
  try {
    const response = await api.post('/api/meals/parse', {
      recipe_text: recipeText
    });

    if (response.data.success) {
      // Success!
    }
  } catch (error) {
    if (error.response?.data?.upgrade_required) {
      // Show upgrade modal
      setShowUpgradeModal(true);
    }
  }
};
```

---

## üß™ Testing Checklist

### Test Scenarios

- [ ] Create checkout session for Family plan
- [ ] Complete payment with test card `4242 4242 4242 4242`
- [ ] Verify subscription status updated in database
- [ ] Test premium feature access (AI parsing)
- [ ] Test usage limits (Family plan: 50 AI parses/month)
- [ ] Cancel subscription (at period end)
- [ ] Cancel subscription (immediately)
- [ ] Test failed payment with card `4000 0000 0000 0341`
- [ ] Webhook events received and processed

### Stripe Test Cards

```
Success: 4242 4242 4242 4242
Decline: 4000 0000 0000 0002
Insufficient funds: 4000 0000 0000 9995
3D Secure required: 4000 0025 0000 3155
```

---

## üöÄ Going to Production

### 1. Switch to Live Mode

1. In Stripe Dashboard, toggle from "Test mode" to "Live mode"
2. Go to Developers ‚Üí API Keys
3. Copy your **Live** secret key (starts with `sk_live_`)
4. Update environment variable:

```bash
# In Railway or production .env
STRIPE_SECRET_KEY=sk_live_xxx  # Your LIVE key
```

### 2. Set Up Production Webhooks

1. Stripe Dashboard (Live mode) ‚Üí Developers ‚Üí Webhooks
2. Add endpoint: `https://your-app.railway.app/api/stripe/webhook`
3. Select events (same as before)
4. Copy webhook secret and add to Railway:

```bash
STRIPE_WEBHOOK_SECRET=whsec_xxx  # Your LIVE webhook secret
```

### 3. Verify Tax Settings

1. Stripe Dashboard ‚Üí Settings ‚Üí Tax
2. Enable Stripe Tax (automatic tax calculation)
3. Or configure manual tax rates

### 4. Set Up Products in Stripe Dashboard

Instead of creating prices on-the-fly, create them in the dashboard:

1. Go to Products ‚Üí Add Product
2. Create products for:
   - Family Plan - $9.99/month
   - Premium Plan - $19.99/month
   - Lifetime - $299 one-time
3. Copy the Price IDs and update your code

### 5. Enable Customer Portal

1. Stripe Dashboard ‚Üí Settings ‚Üí Billing ‚Üí Customer portal
2. Customize branding and settings
3. Enable features:
   - Update payment method
   - Cancel subscription
   - View invoices

---

## üìä Monitoring & Analytics

### Stripe Dashboard

Monitor in real-time:
- Total revenue
- Active subscriptions
- Churn rate
- Failed payments

### Custom Analytics

Track in your app:

```python
# Get subscription stats
@app.route('/api/admin/subscription-stats', methods=['GET'])
def get_subscription_stats():
    conn = db.get_connection()
    cursor = conn.cursor()

    # Count by plan tier
    cursor.execute("""
        SELECT plan_tier, COUNT(*) as count, SUM(price_monthly) as mrr
        FROM subscriptions
        WHERE status = 'active'
        GROUP BY plan_tier
    """)

    stats = cursor.fetchall()
    return jsonify({'success': True, 'stats': stats})
```

---

## üêõ Troubleshooting

### Problem: "No such table: subscriptions"

**Solution**: Run migration:
```bash
python database/migrations/add_subscriptions.py
```

### Problem: "STRIPE_SECRET_KEY not found"

**Solution**: Add to `.env` file:
```bash
STRIPE_SECRET_KEY=sk_test_your_key_here
```

### Problem: Webhooks not received

**Solution**:
1. Check webhook URL is correct
2. Verify STRIPE_WEBHOOK_SECRET is set
3. Test with Stripe CLI: `stripe listen --forward-to localhost:5001/api/stripe/webhook`

### Problem: Payment succeeds but subscription not updated

**Solution**:
1. Check webhook events in Stripe Dashboard ‚Üí Developers ‚Üí Webhooks
2. Look for errors in logs
3. Verify `checkout.session.completed` webhook is enabled

### Problem: "Feature access denied" for paid users

**Solution**:
1. Check subscription status: `SELECT * FROM subscriptions WHERE user_id=X;`
2. Verify plan_features table has correct limits
3. Check if subscription status is 'active' or 'trialing'

---

## üìö API Reference

### Create Checkout Session

```http
POST /api/stripe/create-checkout-session
Content-Type: application/json

{
  "plan_tier": "family",
  "trial_days": 14
}
```

Response:
```json
{
  "success": true,
  "checkout_url": "https://checkout.stripe.com/..."
}
```

### Get Subscription Status

```http
GET /api/stripe/subscription
```

Response:
```json
{
  "success": true,
  "subscription": {
    "plan_tier": "family",
    "status": "active",
    "price_monthly": 9.99,
    "current_period_end": "2024-02-01"
  }
}
```

### Check Feature Access

```http
GET /api/stripe/can-use-feature/ai_recipe_parsing
```

Response:
```json
{
  "success": true,
  "can_access": true,
  "reason": null
}
```

### Cancel Subscription

```http
POST /api/stripe/cancel
Content-Type: application/json

{
  "immediately": false
}
```

---

## ‚úÖ Next Steps

1. ‚úÖ Complete this setup
2. ‚úÖ Test payment flow end-to-end
3. ‚úÖ Add upgrade prompts to premium features
4. ‚úÖ Build pricing page in frontend
5. ‚úÖ Set up production webhooks
6. ‚úÖ Launch and get first paying customer!

---

## üí° Pro Tips

1. **Always test in Test Mode first** - Don't use live keys until ready
2. **Monitor webhooks** - They're critical for subscription management
3. **Handle edge cases** - Failed payments, expired cards, etc.
4. **Communicate clearly** - Tell users when their trial ends
5. **Make cancellation easy** - Happy customers come back

---

## üéâ You're Done!

You now have a complete Stripe payment system integrated into your app.

**Next**: Build the premium features (nutrition, analytics, meal prep) that justify the $9.99/month price!

Questions? Check the code comments in:
- `subscription_manager.py` - Core subscription logic
- `stripe_routes.py` - All API endpoints
- `database/migrations/add_subscriptions.py` - Database schema

**Let's get to $100K MRR!** üöÄ
